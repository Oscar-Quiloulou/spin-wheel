<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>JEU 4 - Ping Pong</title>
  <link rel="stylesheet" href="assets/style.css">

  <style>
    canvas {
      background: rgba(30,41,59,0.8);
      border: 1px solid rgba(148,163,184,0.4);
      border-radius: 12px;
      display: block;
      margin: 0 auto;
      box-shadow: 0 0 20px rgba(15,23,42,0.9);
      touch-action: none;
    }

    /* Menu cheat */
    #cheat-menu {
      position: absolute;
      top: 20px;
      right: -260px;
      width: 240px;
      max-height: 80vh;
      padding: 10px;
      background: rgba(15,23,42,0.97);
      border: 1px solid rgba(129,140,248,0.5);
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(129,140,248,0.4);
      transition: right 0.4s ease;
      z-index: 100;
      overflow-y: auto;
      font-size: 13px;
    }
    #cheat-menu.show {
      right: 20px;
    }

    /* Bouton secret */
    #secret-btn {
      position: absolute;
      bottom: 10px;
      left: 10px;
      width: 40px;
      height: 40px;
      opacity: 0;
      border: none;
      background: transparent;
      z-index: 200;
      cursor: pointer;
    }

    /* Bouton contrôle parental */
    #parental-btn {
      position:absolute;
      top:10px;
      left:10px;
      z-index:300;
    }
  </style>
</head>

<body>

  <div class="card">

    <div class="side-leaderboard">
      <div id="leaderboard"></div>
    </div>

    <!-- Bouton secret -->
    <button id="secret-btn"></button>

    <!-- Bouton contrôle parental -->
    <button id="parental-btn">Contrôle parental</button>

    <!-- Menu cheat dynamique -->
    <div id="cheat-menu">
      <h3>Cheats</h3>
      <div id="cheat-buttons"></div>
    </div>

    <h1>Ping Pong</h1>
    <h2>Utilise ↑ ↓ ou glisse ton doigt</h2>

    <canvas id="gameCanvas" width="480" height="300"></canvas>

    <div id="scoreBox" style="margin-top:10px;font-size:18px;font-weight:600;">
      Score : <span id="score">0</span>
    </div>

    <button id="restart" class="btn">Rejouer</button>
    <a href="index.html">⬅ Retour au menu</a>

  </div>

  <!-- Panneau contrôle parental -->
  <div id="parental-panel" style="
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    width:300px;
    padding:20px;
    background:#0f172a;
    border:1px solid #64748b;
    border-radius:12px;
    color:white;
    display:none;
    z-index:5000;
  ">
    <h3>Contrôle parental</h3>

    <label>Mot de passe :</label>
    <input id="parental-pass" type="password" style="width:100%; margin-bottom:10px;">

    <button id="parental-login" style="width:100%; margin-bottom:10px;">Valider</button>

    <div id="parental-settings" style="display:none;">
      <hr>

      <label>Temps limite (minutes) :</label>
      <input id="limit-time" type="number" value="60" style="width:100%; margin-bottom:10px;">

      <label>Désactiver les cheats :</label>
      <input id="disable-cheats" type="checkbox">

      <h4>Logs :</h4>
      <pre id="cheat-logs" style="background:#1e293b; padding:10px; height:100px; overflow:auto;"></pre>

      <button id="parental-save" style="width:100%; margin-top:10px;">Enregistrer</button>

      <a href="admin.html" style="color:#818cf8; display:block; margin-top:10px; text-align:center;">
        Accéder à l'interface admin
      </a>
    </div>
  </div>
<!-- ========================= -->
<!--   SCRIPT : MOTEUR DU JEU  -->
<!-- ========================= -->

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  let paddleY = canvas.height / 2 - 30;
  const paddleHeight = 60;
  const paddleWidth = 10;

  let ballX = canvas.width / 2;
  let ballY = canvas.height / 2;
  let ballSpeedX = 4;
  let ballSpeedY = 3;
  let ballRadius = 6;

  let score = 0;
  let gameOver = false;

  let autoPaddle = false;
  let magnetPaddle = false;
  let teleportPaddle = false;

  function resetBall() {
    ballX = canvas.width / 2;
    ballY = canvas.height / 2;
    ballSpeedX = 4;
    ballSpeedY = 3;
  }

  function drawPaddle() {
    ctx.fillStyle = "#818cf8";
    ctx.fillRect(10, paddleY, paddleWidth, paddleHeight);
  }

  function drawBall() {
    ctx.beginPath();
    ctx.arc(ballX, ballY, ballRadius, 0, Math.PI * 2);
    ctx.fillStyle = "#f8fafc";
    ctx.fill();
    ctx.closePath();
  }

  function drawScore() {
    document.getElementById("score").textContent = score;
  }

  function update() {
    if (gameOver) return;

    // Auto-paddle
    if (autoPaddle) {
      paddleY += (ballY - (paddleY + paddleHeight / 2)) * 0.1;
    }

    // Magnet paddle
    if (magnetPaddle) {
      if (ballX < 40) {
        ballSpeedX = Math.abs(ballSpeedX);
      }
    }

    // Teleport paddle
    if (teleportPaddle) {
      if (ballX < 40) {
        paddleY = Math.random() * (canvas.height - paddleHeight);
      }
    }

    ballX += ballSpeedX;
    ballY += ballSpeedY;

    // Collisions verticales
    if (ballY + ballRadius > canvas.height || ballY - ballRadius < 0) {
      ballSpeedY = -ballSpeedY;
    }

    // Collision avec la raquette
    if (
      ballX - ballRadius < 20 &&
      ballY > paddleY &&
      ballY < paddleY + paddleHeight
    ) {
      ballSpeedX = -ballSpeedX;
      score++;
    }

    // Game Over
    if (ballX - ballRadius < 0) {
      gameOver = true;
      document.getElementById("restart").style.display = "block";
    }

    // Rebonds mur droit
    if (ballX + ballRadius > canvas.width) {
      ballSpeedX = -ballSpeedX;
    }

    draw();
  }

  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawPaddle();
    drawBall();
    drawScore();
  }

  function gameLoop() {
    update();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();

  // Contrôles clavier
  document.addEventListener("keydown", (e) => {
    if (e.key === "ArrowUp") paddleY -= 20;
    if (e.key === "ArrowDown") paddleY += 20;
  });

  // Contrôles tactiles
  canvas.addEventListener("touchmove", (e) => {
    const touch = e.touches[0];
    const rect = canvas.getBoundingClientRect();
    paddleY = touch.clientY - rect.top - paddleHeight / 2;
  });

  // Bouton rejouer
  document.getElementById("restart").addEventListener("click", () => {
    score = 0;
    gameOver = false;
    resetBall();
    document.getElementById("restart").style.display = "none";
  });
</script>
<!-- ========================================= -->
<!--   SCRIPT : CHEATS + CONTROLE PARENTAL     -->
<!-- ========================================= -->

<script type="module">
  import * as Cheats from "./assets/cheats-pingpong.js";

  // Variables globales appliquées par Firebase
  window.visibleCheats = [];
  window.parentalTimeLimit = 60;
  window.parentalDisableCheats = false;

  // ============================
  //   MENU CHEAT DYNAMIQUE
  // ============================

  const cheatMenu = document.getElementById("cheat-menu");
  const cheatButtons = document.getElementById("cheat-buttons");
  const secretBtn = document.getElementById("secret-btn");

  function renderCheatMenu() {
    cheatButtons.innerHTML = "";

    if (window.parentalDisableCheats) {
      cheatButtons.innerHTML = "<p style='color:#f87171;'>Cheats désactivés</p>";
      return;
    }

    window.visibleCheats.forEach(id => {
      if (Cheats[id]) {
        const btn = document.createElement("button");
        btn.textContent = Cheats[id].label;
        btn.style.width = "100%";
        btn.style.marginBottom = "6px";
        btn.style.padding = "6px";
        btn.style.background = "#334155";
        btn.style.color = "white";
        btn.style.border = "1px solid #64748b";
        btn.style.borderRadius = "6px";
        btn.style.cursor = "pointer";

        btn.addEventListener("click", () => {
          Cheats[id].action();
          addCheatLog(Cheats[id].label);
        });

        cheatButtons.appendChild(btn);
      }
    });
  }

  // Bouton secret → ouvre le menu
  secretBtn.addEventListener("click", () => {
    cheatMenu.classList.toggle("show");
  });

  // ============================
  //   LOGS DES CHEATS
  // ============================

  const cheatLogs = document.getElementById("cheat-logs");

  function addCheatLog(text) {
    const time = new Date().toLocaleTimeString();
    cheatLogs.textContent += `[${time}] ${text}\n`;
    cheatLogs.scrollTop = cheatLogs.scrollHeight;
  }

  // ============================
  //   CONTROLE PARENTAL
  // ============================

  const parentalBtn = document.getElementById("parental-btn");
  const parentalPanel = document.getElementById("parental-panel");
  const parentalLogin = document.getElementById("parental-login");
  const parentalSettings = document.getElementById("parental-settings");

  const parentalPass = document.getElementById("parental-pass");
  const limitTime = document.getElementById("limit-time");
  const disableCheats = document.getElementById("disable-cheats");

  const PARENTAL_PASSWORD = "1234";

  parentalBtn.addEventListener("click", () => {
    parentalPanel.style.display = "block";
  });

  parentalLogin.addEventListener("click", () => {
    if (parentalPass.value === PARENTAL_PASSWORD) {
      parentalSettings.style.display = "block";
    } else {
      alert("Mot de passe incorrect");
    }
  });

  document.getElementById("parental-save").addEventListener("click", () => {
    window.parentalTimeLimit = parseInt(limitTime.value);
    window.parentalDisableCheats = disableCheats.checked;
    renderCheatMenu();
    alert("Paramètres enregistrés !");
  });

  // ============================
  //   APPLICATION DES PARAMÈTRES
  // ============================

  // Timer parental
  setInterval(() => {
    if (!gameOver) {
      const minutes = window.parentalTimeLimit;
      if (minutes > 0) {
        const elapsed = score / 60;
        if (elapsed >= minutes) {
          gameOver = true;
          document.getElementById("restart").style.display = "block";
        }
      }
    }
  }, 1000);

  // Expose renderCheatMenu pour Firebase
  window.renderCheatMenu = renderCheatMenu;
</script>
<!-- ========================================= -->
<!--   SCRIPT : FIREBASE + PARAMÈTRES ADMIN    -->
<!-- ========================================= -->

<script type="module">
  import { loadAdminSettings } from "./assets/firebase-config.js";

  // Charger les paramètres admin depuis Firebase
  loadAdminSettings().then(settings => {
    console.log("Paramètres admin chargés :", settings);

    // Appliquer les paramètres
    window.parentalTimeLimit = settings.defaultTimeLimit;
    window.parentalDisableCheats = !settings.cheatsAllowed;
    window.visibleCheats = settings.visibleCheats;

    // Mettre à jour le panneau parental
    document.getElementById("limit-time").value = settings.defaultTimeLimit;
    document.getElementById("disable-cheats").checked = !settings.cheatsAllowed;

    // Mettre à jour le menu cheat
    if (window.renderCheatMenu) {
      window.renderCheatMenu();
    }
  }).catch(err => {
    console.error("Erreur Firebase :", err);
  });
</script>

</body>
</html>